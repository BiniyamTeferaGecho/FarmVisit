import{G as K,u as $,r as c,j as e,P as Q,ak as Z,T as ee,M as U,C as se}from"./index-gIg6QK8U.js";const te=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],ie=K("eye",te),I=["System","Reports","Employee","RoleManagement","UserManagement"];function D(o){return o&&(o.UserID||o.userId||o.UserId||o.id||o.ID)}const v=o=>!o||typeof o!="string"?!1:/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(o);function ae(){const{user:o}=$(),{fetchWithAuth:h}=$(),[b,X]=c.useState([]),[f,Y]=c.useState({totalCount:0,currentPage:1,pageSize:25}),[B,k]=c.useState(!1),[P,r]=c.useState(null),[A,L]=c.useState(""),[y,z]=c.useState(""),[C,V]=c.useState(""),[i,p]=c.useState({PermissionCode:"",PermissionName:"",PermissionDescription:"",Module:"",SubModule:"",IsActive:!0}),[_,w]=c.useState(!1),[d,m]=c.useState({open:!1,id:null,form:null,saving:!1}),[n,E]=c.useState({open:!1,id:null,data:null}),[x,N]=c.useState({open:!1,id:null,title:"",message:"",processing:!1}),g=async(s=1)=>{k(!0);try{const t={page:s,pageSize:f.pageSize,q:A};y&&(t.module=y),C&&(t.subModule=C);const a=await h({url:"/permissions",method:"get",params:t}),l=a.data&&a.data.data?a.data.data:a.data||{items:[]},j=(l.items||[]).map(u=>{const J=u.PermissionID||u.permissionID||u.PermissionId||u.permissionId||u.id||u.Id||null;return{...u,PermissionID:J}}),R=j.filter(u=>!u.PermissionID);R.length&&console.warn("fetchPermissions: items missing PermissionID",R.slice(0,5)),console.debug("fetchPermissions: loaded PermissionIDs",j.slice(0,5).map(u=>u.PermissionID)),X(j),Y(l.pagination||{totalCount:l.items.length||0,currentPage:s,pageSize:f.pageSize})}catch(t){console.error("fetchPermissions error",t),r({type:"error",text:t?.response?.data?.message||t.message||"Failed to load permissions"})}finally{k(!1)}};c.useEffect(()=>{g(f.currentPage)},[]);const F=()=>p({PermissionCode:"",PermissionName:"",PermissionDescription:"",Module:"",SubModule:"",IsActive:!0}),M=async(s,t=null)=>{if(!s)return!1;try{const a={PermissionCode:s};return t&&v(t)&&(a.ExcludePermissionID=t),(await h({url:"/permissions/check-code",method:"get",params:a,redirectOnFail:!1}))?.data?.data?.exists||!1}catch{return!1}},O=async s=>{if(s.preventDefault(),r(null),!i.PermissionCode||!i.PermissionName||!i.Module){r({type:"error",text:"Code, Name and Module are required"});return}const t=D(o);if(!t){r({type:"error",text:"You must be signed in to create permissions."});return}w(!0);try{if(await M(i.PermissionCode)){r({type:"error",text:"Permission code already exists"}),w(!1);return}const l={PermissionCode:i.PermissionCode.trim(),PermissionName:i.PermissionName.trim(),PermissionDescription:i.PermissionDescription||null,Module:i.Module,SubModule:i.SubModule||null,IsActive:i.IsActive?1:0,CreatedBy:t};await h({url:"/permissions",method:"post",data:l}),r({type:"success",text:"Permission created"}),F(),await g(1)}catch(a){console.error("createPermission error",a),r({type:"error",text:a?.response?.data?.message||a.message||"Failed to create permission"})}finally{w(!1)}},q=s=>{m({open:!0,id:s.PermissionID,form:{PermissionCode:s.PermissionCode,PermissionName:s.PermissionName||"",PermissionDescription:s.PermissionDescription||"",Module:s.Module||"",SubModule:s.SubModule||"",IsActive:!!s.IsActive},saving:!1})},T=async()=>{const{id:s,form:t}=d;if(!t.PermissionName||!t.Module){r({type:"error",text:"Name and Module are required"});return}if(!s||!v(s)){r({type:"error",text:"Invalid PermissionID for update"});return}const a=D(o);if(!a){r({type:"error",text:"You must be signed in to update permissions."});return}m(l=>({...l,saving:!0}));try{if(t.PermissionCode&&await M(t.PermissionCode,s)){r({type:"error",text:"Permission code already exists"}),m(j=>({...j,saving:!1}));return}const l={PermissionCode:t.PermissionCode?t.PermissionCode.trim():void 0,PermissionName:t.PermissionName.trim(),PermissionDescription:t.PermissionDescription||null,Module:t.Module||null,SubModule:t.SubModule||null,IsActive:t.IsActive?1:0,UpdatedBy:a};await h({url:`/permissions/${s}`,method:"patch",data:l}),r({type:"success",text:"Permission updated"}),m({open:!1,id:null,form:null,saving:!1}),await g(f.currentPage)}catch(l){console.error("updatePermission error",l),r({type:"error",text:l?.response?.data?.message||l.message||"Failed to update permission"}),m(S=>({...S,saving:!1}))}},G=s=>{N({open:!0,id:s.PermissionID,title:`Delete ${s.PermissionCode}`,message:"Soft-delete this permission?",processing:!1})},W=async()=>{if(x.open){N(s=>({...s,processing:!0}));try{const s=D(o);if(!s)throw new Error("You must be signed in to delete permissions.");if(!x.id||!v(x.id))throw new Error("Invalid PermissionID for delete");await h({url:`/permissions/${x.id}/delete`,method:"post",data:{UpdatedBy:s}}),r({type:"success",text:"Permission deleted"}),await g(f.currentPage)}catch(s){console.error("deletePermission error",s),r({type:"error",text:s?.response?.data?.message||s.message||"Failed to delete permission"})}finally{N({open:!1,id:null,title:"",message:"",processing:!1})}}},H=async s=>{try{if(!s.PermissionID||!v(s.PermissionID)){r({type:"error",text:"Invalid PermissionID for view"});return}const t=await h({url:`/permissions/${s.PermissionID}/roles`,method:"get"});E({open:!0,id:s.PermissionID,data:t?.data?.data||null})}catch(t){console.error("viewPermission error",t),r({type:"error",text:t?.response?.data?.message||t.message||"Failed to load permission details"})}};return e.jsxs("div",{className:"space-y-6 h-full",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-slate-900",children:"Permissions"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Manage permissions and their role assignments."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{placeholder:"Search",value:A,onChange:s=>L(s.target.value),className:"px-3 py-2 border rounded"}),e.jsxs("select",{value:y,onChange:s=>z(s.target.value),className:"px-3 py-2 border rounded",children:[e.jsx("option",{value:"",children:"All Modules"}),I.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsx("input",{placeholder:"SubModule",value:C,onChange:s=>V(s.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{onClick:()=>g(1),className:"px-3 py-2 bg-white border rounded-md text-sm",children:"Search"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white p-6 rounded-lg shadow-sm text-left",children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"New Permission"}),e.jsxs("form",{onSubmit:O,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Code"}),e.jsx("input",{value:i.PermissionCode,onChange:s=>p({...i,PermissionCode:s.target.value}),onBlur:async s=>{s.target.value&&await M(s.target.value)&&r({type:"error",text:"Permission code already exists"})},className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"}),e.jsx("div",{className:"text-xs text-slate-500 mt-1",children:"Format: PERM_XX_XXXX (XX uppercase letters)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Name"}),e.jsx("input",{value:i.PermissionName,onChange:s=>p({...i,PermissionName:s.target.value}),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Module"}),e.jsxs("select",{value:i.Module,onChange:s=>p({...i,Module:s.target.value}),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm",children:[e.jsx("option",{value:"",children:"-- Select Module --"}),I.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"SubModule"}),e.jsx("input",{value:i.SubModule,onChange:s=>p({...i,SubModule:s.target.value}),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Description"}),e.jsx("textarea",{value:i.PermissionDescription,onChange:s=>p({...i,PermissionDescription:s.target.value}),rows:3,className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:i.IsActive,onChange:s=>p({...i,IsActive:s.target.checked}),className:"form-checkbox h-4 w-4"}),e.jsx("span",{children:"Active"})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"submit",disabled:_,className:"inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md",children:[" ",e.jsx(Q,{className:"h-4 w-4"})," Create"]}),e.jsx("button",{type:"button",onClick:F,className:"px-3 py-2 border rounded-md",children:"Reset"})]}),P&&e.jsx("div",{className:`text-sm ${P.type==="error"?"text-red-600":"text-green-600"}`,children:P.text})]})]}),e.jsxs("div",{className:"lg:col-span-2 bg-white p-6 rounded-lg shadow-sm overflow-auto text-left",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Permissions"}),e.jsx("div",{className:"text-sm text-slate-500",children:B?"Loading...":`${f.totalCount||0} permissions`})]}),e.jsx("div",{className:"w-full overflow-auto",children:e.jsxs("table",{className:"w-full text-sm table-auto text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-slate-600",children:[e.jsx("th",{className:"p-3",children:"Code"}),e.jsx("th",{className:"p-3",children:"Name"}),e.jsx("th",{className:"p-3",children:"Module"}),e.jsx("th",{className:"p-3",children:"Active"}),e.jsx("th",{className:"p-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[b&&b.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-3 text-slate-500",children:"No permissions found."})}),b&&b.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3 align-top font-medium text-slate-800",children:s.PermissionCode}),e.jsx("td",{className:"p-3 align-top text-slate-600",children:s.PermissionName||"-"}),e.jsx("td",{className:"p-3 align-top text-slate-500",children:s.Module||"-"}),e.jsx("td",{className:"p-3 align-top",children:s.IsActive?e.jsx("span",{className:"text-green-600",children:"Yes"}):e.jsx("span",{className:"text-red-600",children:"No"})}),e.jsx("td",{className:"p-3 align-top",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>H(s),className:"p-2 rounded-md hover:bg-gray-100",title:"View",children:e.jsx(ie,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>q(s),className:"p-2 rounded-md hover:bg-gray-100",title:"Edit",children:e.jsx(Z,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>G(s),className:"p-2 rounded-md hover:bg-red-50 text-red-600",title:"Delete",children:e.jsx(ee,{className:"h-4 w-4"})})]})})]},s.PermissionID))]})]})})]})]}),e.jsx(U,{open:d.open,onClose:()=>m({open:!1,id:null,form:null}),title:d.form?`Edit: ${d.form.PermissionCode}`:"Edit Permission",children:d.form&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-slate-700 block mb-1",children:"Code"}),e.jsx("input",{value:d.form.PermissionCode,onChange:s=>m(t=>({...t,form:{...t.form,PermissionCode:s.target.value}})),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-slate-700 block mb-1",children:"Name"}),e.jsx("input",{value:d.form.PermissionName,onChange:s=>m(t=>({...t,form:{...t.form,PermissionName:s.target.value}})),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-slate-700 block mb-1",children:"Module"}),e.jsxs("select",{value:d.form.Module,onChange:s=>m(t=>({...t,form:{...t.form,Module:s.target.value}})),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm",children:[e.jsx("option",{value:"",children:"-- Select Module --"}),I.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-slate-700 block mb-1",children:"SubModule"}),e.jsx("input",{value:d.form.SubModule,onChange:s=>m(t=>({...t,form:{...t.form,SubModule:s.target.value}})),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-slate-700 block mb-1",children:"Description"}),e.jsx("textarea",{value:d.form.PermissionDescription,onChange:s=>m(t=>({...t,form:{...t.form,PermissionDescription:s.target.value}})),rows:3,className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!d.form.IsActive,onChange:s=>m(t=>({...t,form:{...t.form,IsActive:s.target.checked}})),className:"form-checkbox h-4 w-4"}),e.jsx("span",{children:"Active"})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>m({open:!1,id:null,form:null}),className:"px-4 py-2 rounded border",children:"Cancel"}),e.jsx("button",{onClick:T,disabled:d.saving,className:"px-4 py-2 bg-indigo-600 text-white rounded",children:d.saving?"Saving...":"Update"})]})]})}),e.jsx(U,{open:n.open,onClose:()=>E({open:!1,id:null,data:null}),title:n.data&&n.data.permission?`Permission: ${n.data.permission.PermissionCode}`:"Permission",children:n.data&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Code:"})," ",n.data.permission.PermissionCode]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Name:"})," ",n.data.permission.PermissionName]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Module:"})," ",n.data.permission.Module]}),e.jsxs("div",{children:[e.jsx("strong",{children:"SubModule:"})," ",n.data.permission.SubModule||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Description:"})," ",n.data.permission.PermissionDescription||"-"]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"Assigned Roles"}),e.jsxs("div",{className:"mt-2 max-h-56 overflow-auto",children:[n.data.roles&&n.data.roles.length===0&&e.jsx("div",{className:"text-sm text-slate-500",children:"No role assignments."}),n.data.roles&&n.data.roles.map(s=>e.jsxs("div",{className:"flex items-center justify-between border-b py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.RoleName}),e.jsx("div",{className:"text-xs text-slate-500",children:s.RoleDescription||""})]}),e.jsxs("div",{className:"text-xs text-slate-600",children:["View:",s.CanView?"Y":"N"," Create:",s.CanCreate?"Y":"N"," Edit:",s.CanEdit?"Y":"N"]})]},s.RolePermissionID))]})]})]})}),e.jsx(se,{open:x.open,title:x.title,message:x.message,onCancel:()=>N({open:!1,id:null,title:"",message:"",processing:!1}),onConfirm:W,confirmLabel:"Yes",cancelLabel:"No",loading:x.processing})]})}export{ae as default};
