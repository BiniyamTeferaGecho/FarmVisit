import{u as W,r as l,j as s,P as A,ak as H,T as J,M as E,C as K}from"./index-gIg6QK8U.js";function N(o){return o&&(o.UserID||o.userId||o.UserId||o.id||o.ID)}function Q(){const{user:o,fetchWithAuth:m}=W(),[g,k]=l.useState([]),[M,y]=l.useState(!1),[u,r]=l.useState(null),[f,S]=l.useState({totalCount:0,currentPage:1,pageSize:25}),[I,T]=l.useState([]),[D,U]=l.useState([]),[i,b]=l.useState({GroupID:"",UserID:"",MembershipType:"MEMBER",IsActive:!0}),[F,w]=l.useState(!1),[d,c]=l.useState({open:!1,id:null,form:null,saving:!1}),[x,j]=l.useState({open:!1,id:null,title:"",message:"",processing:!1}),[h,p]=l.useState({open:!1,GroupID:"",UserIDs:[],processing:!1}),v=async(e=1)=>{y(!0);try{const t=await m({url:"/group-users",method:"get",params:{page:e,pageSize:f.pageSize}}),a=t.data&&t.data.data?t.data.data:t.data||[];k(a.items||t.data||a||[]),S(n=>({...n,currentPage:e,totalCount:a&&a.pagination&&a.pagination.totalCount||t.data&&t.data.totalCount||a.totalCount||a.length||0}))}catch(t){console.error("fetchGroupUsers error",t),r({type:"error",text:t?.response?.data?.message||t.message||"Failed to load group users"})}finally{y(!1)}},B=async()=>{try{const e=await m({url:"/groups",method:"get",params:{page:1,pageSize:1e3}}),t=e.data&&e.data.data?e.data.data:e.data||[];T(Array.isArray(t)?t:t.items||[])}catch(e){console.warn("fetchGroups",e)}},G=async e=>{if(!e)return U([]);try{const t=await m({url:`/group-users/available/${e}`,method:"get"});U(t.data&&t.data.data?t.data.data:t.data||[])}catch(t){console.warn("fetchAvailableUsers",t)}};l.useEffect(()=>{v(1),B()},[]);const C=()=>b({GroupID:"",UserID:"",MembershipType:"MEMBER",IsActive:!0}),P=async e=>{if(e.preventDefault(),r(null),!i.GroupID||!i.UserID){r({type:"error",text:"Group and User are required"});return}const t=N(o);if(!t){r({type:"error",text:"You must be signed in to assign users."});return}w(!0);try{const a={GroupID:i.GroupID,UserID:i.UserID,MembershipType:i.MembershipType,IsActive:i.IsActive?1:0,CreatedBy:t};await m({url:"/group-users",method:"post",data:a}),r({type:"success",text:"User added to group"}),C(),await v(1)}catch(a){console.error("createGroupUser error",a),r({type:"error",text:a?.response?.data?.message||a.message||"Failed to add user"})}finally{w(!1)}},R=e=>c({open:!0,id:e.GroupUserID||e.Id||null,form:{IsActive:!!e.IsActive,MembershipType:e.MembershipType||"MEMBER",EffectiveFrom:e.EffectiveFrom,EffectiveTo:e.EffectiveTo},saving:!1}),L=async()=>{const{id:e,form:t}=d;if(!e)return;const a=N(o);c(n=>({...n,saving:!0}));try{await m({url:`/group-users/${e}`,method:"put",data:{MembershipType:t.MembershipType,IsActive:t.IsActive?1:0,EffectiveFrom:t.EffectiveFrom,EffectiveTo:t.EffectiveTo,UpdatedBy:a}}),r({type:"success",text:"Updated"}),c({open:!1,id:null,form:null,saving:!1}),await v(f.currentPage)}catch(n){console.error("updateGroupUser error",n),r({type:"error",text:n?.response?.data?.message||n.message||"Failed to update"}),c(q=>({...q,saving:!1}))}},$=e=>j({open:!0,id:e.GroupUserID||e.Id||null,title:"Remove user from group",message:"Remove this user from the group?",processing:!1}),z=async()=>{if(x.open){j(e=>({...e,processing:!0}));try{if(!N(o))throw new Error("You must be signed in to remove users.");await m({url:`/group-users/${x.id}`,method:"delete"}),r({type:"success",text:"Removed"}),await v(f.currentPage)}catch(e){console.error("deleteGroupUser error",e),r({type:"error",text:e?.response?.data?.message||e.message||"Failed to remove user"})}finally{j({open:!1,id:null,title:"",message:"",processing:!1})}}},Y=async()=>{const e=h;if(!e.GroupID||!Array.isArray(e.UserIDs)||e.UserIDs.length===0){r({type:"error",text:"Select a group and at least one user"});return}p(t=>({...t,processing:!0}));try{const t=N(o),a=e.UserIDs.map(n=>({UserID:n,MembershipType:"MEMBER",IsActive:1}));await m({url:"/group-users/bulk-assign",method:"post",data:{GroupID:e.GroupID,UserAssignments:a,CreatedBy:t}}),r({type:"success",text:"Users assigned"}),p({open:!1,GroupID:"",UserIDs:[],processing:!1}),await v(f.currentPage)}catch(t){console.error("bulkAssignUsers error",t),r({type:"error",text:t?.response?.data?.message||t.message||"Failed to assign users"}),p(a=>({...a,processing:!1}))}};return s.jsxs("div",{className:"space-y-6 h-full",children:[s.jsxs("header",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-semibold text-slate-900",children:"Group Users"}),s.jsx("p",{className:"text-sm text-slate-500",children:"Manage group memberships for users."})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:()=>p(e=>({...e,open:!0})),className:"px-3 py-2 border rounded",children:"Bulk Assign"}),s.jsxs("button",{onClick:()=>c({open:!0,id:null,form:{...i},saving:!1}),className:"inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded-md text-sm",children:[" ",s.jsx(A,{className:"h-4 w-4"})," New"]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[s.jsxs("div",{className:"lg:col-span-1 bg-white p-6 rounded-lg shadow-sm text-left",children:[s.jsx("h3",{className:"text-lg font-medium mb-4",children:"Add User to Group"}),s.jsxs("form",{onSubmit:P,className:"space-y-3",children:[s.jsxs("div",{children:[s.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Group"}),s.jsxs("select",{value:i.GroupID||"",onChange:e=>{b(t=>({...t,GroupID:e.target.value})),G(e.target.value)},className:"w-full px-3 py-2 border rounded",children:[s.jsx("option",{value:"",children:"-- Select group --"}),I.map(e=>s.jsx("option",{value:e.GroupID,children:e.GroupName},e.GroupID))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"User"}),s.jsxs("select",{value:i.UserID||"",onChange:e=>b(t=>({...t,UserID:e.target.value})),className:"w-full px-3 py-2 border rounded",children:[s.jsx("option",{value:"",children:"-- Select user --"}),D.map(e=>s.jsx("option",{value:e.UserID||e.Id,children:e.Username||e.FullName||e.Email||e.UserName},e.UserID||e.Id))]})]}),s.jsx("div",{className:"flex items-center gap-3",children:s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:i.IsActive,onChange:e=>b(t=>({...t,IsActive:e.target.checked})),className:"form-checkbox h-4 w-4"}),s.jsx("span",{children:"Active"})]})}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{type:"submit",disabled:F,className:"inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md",children:[" ",s.jsx(A,{className:"h-4 w-4"})," Create"]}),s.jsx("button",{type:"button",onClick:C,className:"px-3 py-2 border rounded-md",children:"Reset"})]}),u&&s.jsx("div",{className:`text-sm ${u.type==="error"?"text-red-600":"text-green-600"}`,children:u.text})]})]}),s.jsxs("div",{className:"lg:col-span-2 bg-white p-6 rounded-lg shadow-sm overflow-auto text-left",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("h3",{className:"text-lg font-medium",children:"All Group Memberships"}),s.jsx("div",{className:"text-sm text-slate-500",children:M?"Loading...":`${f.totalCount||g.length||0} memberships`})]}),s.jsx("div",{className:"w-full overflow-auto",children:s.jsxs("table",{className:"w-full text-sm table-auto text-left",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"text-left text-slate-600",children:[s.jsx("th",{className:"p-3",children:"Group"}),s.jsx("th",{className:"p-3",children:"User"}),s.jsx("th",{className:"p-3",children:"Active"}),s.jsx("th",{className:"p-3",children:"Effective"}),s.jsx("th",{className:"p-3",children:"Actions"})]})}),s.jsxs("tbody",{children:[g&&g.length===0&&s.jsx("tr",{children:s.jsx("td",{colSpan:5,className:"p-3 text-slate-500",children:"No memberships found."})}),g&&g.map(e=>s.jsxs("tr",{className:"border-t",children:[s.jsx("td",{className:"p-3 align-top font-medium text-slate-800",children:e.GroupName||e.Group||"-"}),s.jsx("td",{className:"p-3 align-top text-slate-600",children:e.Username||e.UserName||e.FullName||"-"}),s.jsx("td",{className:"p-3 align-top",children:e.IsActive?s.jsx("span",{className:"text-green-600",children:"Yes"}):s.jsx("span",{className:"text-red-600",children:"No"})}),s.jsxs("td",{className:"p-3 align-top text-slate-600",children:[e.EffectiveFrom?new Date(e.EffectiveFrom).toLocaleDateString():"-"," â€” ",e.EffectiveTo?new Date(e.EffectiveTo).toLocaleDateString():"-"]}),s.jsx("td",{className:"p-3 align-top",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:()=>R(e),className:"p-2 rounded-md hover:bg-gray-100",title:"Edit",children:s.jsx(H,{className:"h-4 w-4"})}),s.jsx("button",{onClick:()=>$(e),className:"p-2 rounded-md hover:bg-red-50 text-red-600",title:"Delete",children:s.jsx(J,{className:"h-4 w-4"})})]})})]},e.GroupUserID||e.Id||`${e.GroupID}-${e.UserID}`))]})]})})]})]}),s.jsx(E,{open:d.open,onClose:()=>c({open:!1,id:null,form:null}),title:(d.form,"Edit Membership"),children:d.form&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"text-sm block mb-1",children:"Membership Type"}),s.jsx("input",{value:d.form.MembershipType||"",onChange:e=>c(t=>({...t,form:{...t.form,MembershipType:e.target.value}})),className:"w-full px-3 py-2 border rounded"})]}),s.jsx("div",{className:"flex items-center gap-3",children:s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:!!d.form.IsActive,onChange:e=>c(t=>({...t,form:{...t.form,IsActive:e.target.checked}})),className:"form-checkbox h-4 w-4"}),s.jsx("span",{children:"Active"})]})}),s.jsxs("div",{className:"flex justify-end gap-2",children:[s.jsx("button",{onClick:()=>c({open:!1,id:null,form:null}),className:"px-4 py-2 rounded border",children:"Cancel"}),s.jsx("button",{onClick:L,disabled:d.saving,className:"px-4 py-2 bg-indigo-600 text-white rounded",children:d.saving?"Saving...":"Update"})]}),u&&s.jsx("div",{className:`text-sm ${u.type==="error"?"text-red-600":"text-green-600"}`,children:u.text})]})}),s.jsx(E,{open:h.open,onClose:()=>p({open:!1,GroupID:"",UserIDs:[],processing:!1}),title:"Bulk Assign Users",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"text-sm block mb-1",children:"Group"}),s.jsxs("select",{value:h.GroupID||"",onChange:e=>{const t=e.target.value;p(a=>({...a,GroupID:t})),G(t)},className:"w-full px-3 py-2 border rounded",children:[s.jsx("option",{value:"",children:"-- Select group --"}),I.map(e=>s.jsx("option",{value:e.GroupID,children:e.GroupName},e.GroupID))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"text-sm block mb-1",children:"Users"}),s.jsx("div",{className:"grid grid-cols-2 gap-2 max-h-48 overflow-auto border p-2 rounded",children:D.map(e=>s.jsxs("label",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",checked:h.UserIDs.includes(e.UserID||e.Id),onChange:t=>p(a=>({...a,UserIDs:t.target.checked?[...a.UserIDs,e.UserID||e.Id]:a.UserIDs.filter(n=>n!==(e.UserID||e.Id))}))}),e.Username||e.FullName||e.Email||e.UserName]},e.UserID||e.Id))})]}),s.jsxs("div",{className:"flex justify-end gap-2",children:[s.jsx("button",{onClick:()=>p({open:!1,GroupID:"",UserIDs:[],processing:!1}),className:"px-3 py-2 border rounded",children:"Cancel"}),s.jsx("button",{onClick:Y,disabled:h.processing,className:"px-3 py-2 bg-indigo-600 text-white rounded",children:h.processing?"Processing...":"Assign"})]})]})}),s.jsx(K,{open:x.open,title:x.title,message:x.message,onCancel:()=>j({open:!1,id:null,title:"",message:"",processing:!1}),onConfirm:z,confirmLabel:"Yes",cancelLabel:"No",loading:x.processing})]})}export{Q as default};
