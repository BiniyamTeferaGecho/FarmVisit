import{u as ye,a as fe,r as u,j as e,o as be,v as je,w as ve,A as Fe,p as Ne,L as Ce,k as we,e as g,x as Se,l as J,M as q,y as ke,z as _,F as H,b as Ae,c as Pe,B as F,C as Ie}from"./index-gIg6QK8U.js";const V={FarmName:"",FarmType:"",FarmOwner:"",ContactPerson:"",ContactPhone:"",ContactEmail:"",Address:"",Region:"",Zone:"",Woreda:"",Kebele:"",FarmStatus:"",OwnershipType:"",ProductionSystem:"",WaterSource:"",FarmSize:"",NumberOfPlots:"",IsActive:!0,Latitude:"",Longitude:""},k={phone:n=>!n||[/^(\+2519\d{7}|09\d{8})$/.test(n),/^(\+2511\d{7}|14\d{8})$/.test(n),/^(\+2517\d{7}|07\d{8})$/.test(n)],email:n=>!n||/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(n),farmType:n=>!n||["Dairy","Layer","Broiler"].includes(n),farmStatus:n=>!n||["Active","Inactive","Under Construction"].includes(n)};function Te(){const{user:n,fetchWithAuth:h}=ye(),U=fe(),[B,A]=u.useState([]),[f,d]=u.useState(!1),[o,P]=u.useState(V),[I,R]=u.useState(null),[Q,b]=u.useState(!1),[X,L]=u.useState(!1),[T,W]=u.useState(null),[N,G]=u.useState(null),[Y,C]=u.useState(!1),[D,$]=u.useState(null),[M,w]=u.useState(""),[z,O]=u.useState(!1),[S,i]=u.useState(null),[ee,K]=u.useState(!1),[j,E]=u.useState({});u.useEffect(()=>{y()},[]),u.useEffect(()=>{S&&K(!0)},[S]);const p=t=>{try{const a=t?.response?.data||t?.data||null;return a?typeof a=="string"?a:a.message?a.message:a.error?a.error:JSON.stringify(a):t?.message||String(t)}catch{return t?.message||"Unknown error"}},y=async()=>{d(!0),i(null);try{const t=await h({url:"/farms",method:"get"}),a=t.data?.data||t.data,r=(l=>{if(!l)return null;if(Array.isArray(l))return l;if(Array.isArray(l.items))return l.items;if(Array.isArray(l.recordset))return l.recordset;if(Array.isArray(l.rows))return l.rows;if(Array.isArray(l.data))return l.data;for(const x of Object.keys(l))if(Array.isArray(l[x]))return l[x];return null})(a);r?A(r):a&&typeof a=="object"&&(a.FarmID||a.FarmName)?A([a]):(console.debug("fetchList /farms: unexpected payload",a),A([]))}catch(t){i(p(t)),t?.response?.status===401&&U("/login")}finally{d(!1)}},te=()=>{R(null),P(V),E({}),b(!0)},ae=async t=>{d(!0),i(null);try{const a=await h({url:`/farms/${t}`,method:"get"}),r=a.data?.data||a.data;r&&(P({FarmName:r.FarmName||"",FarmType:r.FarmType||"",FarmOwner:r.FarmOwner||"",ContactPerson:r.ContactPerson||"",ContactPhone:r.ContactPhone||"",ContactEmail:r.ContactEmail||"",Address:r.Address||"",Region:r.Region||"",Zone:r.Zone||"",Woreda:r.Woreda||"",Kebele:r.Kebele||"",FarmStatus:r.FarmStatus||"",OwnershipType:r.OwnershipType||"",ProductionSystem:r.ProductionSystem||"",WaterSource:r.WaterSource||"",FarmSize:r.FarmSize||"",NumberOfPlots:r.NumberOfPlots||"",IsActive:r.IsActive===void 0?!0:!!r.IsActive,Latitude:r.Latitude||"",Longitude:r.Longitude||""}),R(t),b(!0))}catch(a){i(p(a)||"Failed to load")}finally{d(!1)}},re=t=>{const a={};return t.FarmName||(a.FarmName="Farm name is required"),t.FarmType||(a.FarmType="Farm type is required"),k.farmType(t.FarmType)||(a.FarmType="Invalid farm type"),k.phone(t.ContactPhone)||(a.ContactPhone="Invalid phone number"),k.email(t.ContactEmail)||(a.ContactEmail="Invalid email address"),k.farmStatus(t.FarmStatus)||(a.FarmStatus="Invalid farm status"),a},c=t=>{const{name:a,value:r,type:l,checked:x}=t.target;P(s=>({...s,[a]:l==="checkbox"?x:r}))},se=async t=>{t.preventDefault(),E({}),i(null);const a=re(o);if(Object.keys(a).length){E(a);return}d(!0);try{const r={...o,CreatedBy:n?.UserID||n?.id};I?await h({url:`/farms/${I}`,method:"put",data:{...r,UpdatedBy:n?.UserID||n?.id}}):await h({url:"/farms",method:"post",data:r}),b(!1),y()}catch(r){i(p(r)||"Save failed"),r?.response?.status===401&&U("/login")}finally{d(!1)}},ne=t=>{W(t),L(!0)},le=async()=>{if(T){d(!0),i(null);try{await h({url:`/farms/${T.FarmID}/delete`,method:"post",data:{DeletedBy:n?.UserID||n?.id}}),L(!1),W(null),y()}catch(t){i(p(t)||"Delete failed")}finally{d(!1)}}},oe=async t=>{d(!0),i(null);try{await h({url:`/farms/${t.FarmID}/restore`,method:"post",data:{RestoredBy:n?.UserID||n?.id}}),y()}catch(a){i(p(a)||"Restore failed")}finally{d(!1)}},ie=async t=>{if(window.confirm("Are you sure you want to permanently delete this farm? This action cannot be undone.")){d(!0),i(null);try{await h({url:`/farms/${t.FarmID}/permanent-delete`,method:"delete",data:{DeletedBy:n?.UserID||n?.id}}),y()}catch(a){i(p(a)||"Permanent delete failed")}finally{d(!1)}}},ce=t=>G(t.target.files?.[0]||null),de=async()=>{if(N){d(!0),i(null);try{const r=(await N.text()).split(/\r?\n/).filter(Boolean).map((l,x)=>{if(x===0&&l.toLowerCase().includes("farmname"))return null;const s=l.split(",").map(v=>v.trim());return{FarmName:s[0]||null,FarmType:s[1]||null,FarmOwner:s[2]||null,ContactPerson:s[3]||null,ContactPhone:s[4]||null,ContactEmail:s[5]||null,Address:s[6]||null,Region:s[7]||null,Zone:s[8]||null,Woreda:s[9]||null,Kebele:s[10]||null,FarmStatus:s[11]||null,OwnershipType:s[12]||null,ProductionSystem:s[13]||null,WaterSource:s[14]||null,FarmSize:s[15]||null,NumberOfPlots:s[16]||null,IsActive:s[17]===void 0||s[17]==="1"||s[17]==="true"?1:0,Latitude:s[18]||null,Longitude:s[19]||null}}).filter(Boolean);await h({url:"/farms/bulk",method:"post",data:{FarmData:r,CreatedBy:n?.UserID||n?.id}}),G(null),y()}catch(t){i(p(t)||"Bulk upload failed")}finally{d(!1)}}},me=()=>{const t=["FarmName","FarmType","FarmOwner","ContactPerson","ContactPhone","ContactEmail","Address","Region","Zone","Woreda","Kebele","FarmStatus","OwnershipType","ProductionSystem","WaterSource","FarmSize","NumberOfPlots","IsActive","Latitude","Longitude"],a=["My Farm","Dairy","John Doe","Jane Doe","0912345678","jane@example.com","123 Main St","RegionA","ZoneA","WoredaA","KebeleA","Active","Private","Intensive","Borehole","100","5","1","9.0000","38.0000"],r=[t.join(","),a.join(",")].join(`\r
`),l=new Blob([r],{type:"text/csv;charset=utf-8;"}),x=URL.createObjectURL(l),s=document.createElement("a");s.href=x,s.download="farms_import_template.csv",document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(x)},ue=t=>{$(t);const a=t.Latitude||t.latitude||"",r=t.Longitude||t.longitude||"";w(a||r?`${a||""},${r||""}`:""),C(!0)},xe=t=>{const{value:a}=t.target;w(a)},he=async()=>{if(D){d(!0),i(null);try{const a=(M||"").trim().match(/(-?\d+\.?\d*)[ ,]+(-?\d+\.?\d*)/);if(!a){i("Invalid coordinates. Use format: lat,lon"),d(!1);return}const r=a[1],l=a[2],x=`${r},${l}`;await h({url:`/farms/${D.FarmID}/gps`,method:"put",data:{GPSLocation:x,UpdatedBy:n?.UserID||n?.id}}),C(!1),$(null),w(""),y()}catch(t){i(p(t)||"GPS update failed")}finally{d(!1)}}},ge=()=>{if(!navigator.geolocation){i("Geolocation is not supported by your browser");return}O(!0),i(null),navigator.geolocation.getCurrentPosition(t=>{const a=t.coords.latitude.toFixed(6),r=t.coords.longitude.toFixed(6);w(`${a},${r}`),O(!1)},t=>{O(!1),i(t?.message||"Failed to get location")},{enableHighAccuracy:!0,timeout:1e4})},m=({icon:t,label:a,name:r,value:l,onChange:x,error:s,...v})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-gray-700 dark:text-gray-300",children:a}),e.jsxs("div",{className:"text-left relative mt-1",children:[e.jsx("div",{className:"text-left absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400",children:t}),e.jsx("input",{name:r,value:l,onChange:x,className:"text-left block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white",...v})]}),s&&e.jsx("p",{className:"text-left mt-1 text-xs text-red-500",children:s})]}),Z=({icon:t,label:a,name:r,value:l,onChange:x,error:s,children:v,...pe})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-gray-700 dark:text-gray-300",children:a}),e.jsxs("div",{className:"text-left relative mt-1",children:[e.jsx("div",{className:"text-left absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400",children:t}),e.jsx("select",{name:r,value:l,onChange:x,className:"text-left block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white",...pe,children:v})]}),s&&e.jsx("p",{className:"text-left mt-1 text-xs text-red-500",children:s})]});return e.jsxs("main",{className:"text-left flex-1 p-6 bg-gray-100 dark:bg-gray-900",children:[e.jsxs("div",{className:"text-left bg-white dark:bg-gray-800 shadow-md rounded-lg p-6",children:[e.jsxs("div",{className:"text-left flex flex-col md:flex-row justify-between items-start md:items-center mb-6",children:[e.jsx("h1",{className:"text-left text-2xl font-bold text-gray-800 dark:text-white",children:"Manage Farms"}),e.jsxs("div",{className:"text-left flex items-center space-x-2 mt-4 md:mt-0",children:[e.jsxs("button",{onClick:te,className:"flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2",children:[e.jsx(be,{className:"mr-2"})," New Farm"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",onChange:ce}),e.jsxs("button",{className:"flex items-center px-4 py-2 bg-teal-600 text-white rounded-lg shadow-md hover:bg-teal-700",children:[e.jsx(je,{className:"mr-2"})," ",N?"File Selected":"Bulk Upload"]})]}),N&&e.jsx("button",{onClick:de,className:"flex items-center px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700",children:"Upload"}),e.jsxs("button",{onClick:me,className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-600",children:[e.jsx(ve,{className:"mr-2"})," Template"]})]})]}),S?e.jsx("div",{className:"mb-4 p-4 bg-red-100 text-red-700 border border-red-400 rounded-lg",children:"An error occurred. Please try again."}):null,e.jsx(Fe,{open:ee,title:"Error",message:"An unexpected error occurred. Please try again or contact support.",details:S,onClose:()=>{K(!1),i(null)}}),e.jsx("div",{className:"flex items-center space-x-2 mb-4",children:e.jsxs("button",{onClick:()=>y(),className:"flex items-center px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600",children:[e.jsx(Ne,{className:"mr-2"})," Refresh"]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm text-left text-gray-700 dark:text-gray-300",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700 text-xs text-gray-700 dark:text-gray-300 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3",children:"#"}),e.jsx("th",{className:"px-4 py-3",children:"Farm Name"}),e.jsx("th",{className:"px-4 py-3",children:"Type"}),e.jsx("th",{className:"px-4 py-3",children:"Owner"}),e.jsx("th",{className:"px-4 py-3",children:"Contact"}),e.jsx("th",{className:"px-4 py-3",children:"Region"}),e.jsx("th",{className:"px-4 py-3",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-center",children:"Actions"})]})}),e.jsx("tbody",{children:f?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"text-center p-4",children:e.jsx(Ce,{})})}):B.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"text-center p-4",children:"No farms found."})}):B.map((t,a)=>e.jsxs("tr",{className:"border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600",children:[e.jsx("td",{className:"px-4 py-3",children:a+1}),e.jsx("td",{className:"px-4 py-3 font-medium text-gray-900 dark:text-white whitespace-nowrap",children:t.FarmName||""}),e.jsx("td",{className:"px-4 py-3",children:t.FarmType||t.Type||t.FarmTypeCode||t.FarmTypeName||""}),e.jsx("td",{className:"px-4 py-3",children:t.FarmOwner||t.OwnerName||t.Owner||t.FarmerName||t.ContactPerson||""}),e.jsx("td",{className:"px-4 py-3",children:t.ContactPhone||t.ContactNumber||t.Phone||t.WorkPhone||t.ContactEmail||""}),e.jsx("td",{className:"px-4 py-3",children:t.Region||t.RegionName||t.LocationRegion||t.Area||""}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${t.IsActive?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:t.IsActive?"Active":"Inactive"})}),e.jsxs("td",{className:"px-4 py-3 flex items-center justify-center space-x-2",children:[e.jsx("button",{onClick:()=>ae(t.FarmID),className:"text-indigo-500 hover:text-indigo-700",children:e.jsx(we,{})}),e.jsx("button",{onClick:()=>ue(t),className:"text-blue-500 hover:text-blue-700",children:e.jsx(g,{})}),t.DeletedAt?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>oe(t),className:"text-green-500 hover:text-green-700",children:e.jsx(Se,{})}),e.jsx("button",{onClick:()=>ie(t),className:"text-red-700 hover:text-red-900",children:e.jsx(J,{})})]}):e.jsx("button",{onClick:()=>ne(t),className:"text-red-500 hover:text-red-700",children:e.jsx(J,{})})]})]},t.FarmID||a))})]})})]}),e.jsx(q,{open:Q,onClose:()=>b(!1),title:I?"Edit Farm":"Create New Farm",children:e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(m,{icon:e.jsx(ke,{}),label:"Farm Name",name:"FarmName",value:o.FarmName,onChange:c,error:j.FarmName,placeholder:"e.g. Green Valley Farms"}),e.jsxs(Z,{icon:e.jsx(_,{}),label:"Farm Type",name:"FarmType",value:o.FarmType,onChange:c,error:j.FarmType,children:[e.jsx("option",{value:"",children:"Select Type"}),e.jsx("option",{children:"Dairy"}),e.jsx("option",{children:"Layer"}),e.jsx("option",{children:"Broiler"})]}),e.jsx(m,{icon:e.jsx(H,{}),label:"Farm Owner",name:"FarmOwner",value:o.FarmOwner,onChange:c,placeholder:"e.g. John Doe"}),e.jsx(m,{icon:e.jsx(H,{}),label:"Contact Person",name:"ContactPerson",value:o.ContactPerson,onChange:c,placeholder:"e.g. Jane Doe"}),e.jsx(m,{icon:e.jsx(Ae,{}),label:"Contact Phone",name:"ContactPhone",value:o.ContactPhone,onChange:c,error:j.ContactPhone,placeholder:"0912345678"}),e.jsx(m,{icon:e.jsx(Pe,{}),label:"Contact Email",name:"ContactEmail",value:o.ContactEmail,onChange:c,error:j.ContactEmail,placeholder:"contact@farm.com"}),e.jsx(m,{icon:e.jsx(g,{}),label:"Address",name:"Address",value:o.Address,onChange:c,placeholder:"123 Main St"}),e.jsx(m,{icon:e.jsx(g,{}),label:"Region",name:"Region",value:o.Region,onChange:c,placeholder:"e.g. Amhara"}),e.jsx(m,{icon:e.jsx(g,{}),label:"Zone",name:"Zone",value:o.Zone,onChange:c,placeholder:"e.g. North Shewa"}),e.jsx(m,{icon:e.jsx(g,{}),label:"Woreda",name:"Woreda",value:o.Woreda,onChange:c,placeholder:"e.g. Debre Berhan"}),e.jsx(m,{icon:e.jsx(g,{}),label:"Kebele",name:"Kebele",value:o.Kebele,onChange:c,placeholder:"e.g. 01"}),e.jsxs(Z,{icon:e.jsx(_,{}),label:"Farm Status",name:"FarmStatus",value:o.FarmStatus,onChange:c,error:j.FarmStatus,children:[e.jsx("option",{value:"",children:"Select Status"}),e.jsx("option",{children:"Active"}),e.jsx("option",{children:"Inactive"}),e.jsx("option",{children:"Under Construction"})]}),e.jsx(m,{icon:e.jsx(F,{}),label:"Ownership Type",name:"OwnershipType",value:o.OwnershipType,onChange:c,placeholder:"e.g. Private, Cooperative"}),e.jsx(m,{icon:e.jsx(F,{}),label:"Production System",name:"ProductionSystem",value:o.ProductionSystem,onChange:c,placeholder:"e.g. Intensive, Extensive"}),e.jsx(m,{icon:e.jsx(F,{}),label:"Water Source",name:"WaterSource",value:o.WaterSource,onChange:c,placeholder:"e.g. Borehole, River"}),e.jsx(m,{icon:e.jsx(F,{}),label:"Farm Size (in ha)",name:"FarmSize",value:o.FarmSize,onChange:c,type:"number",placeholder:"100"}),e.jsx(m,{icon:e.jsx(F,{}),label:"Number of Plots",name:"NumberOfPlots",value:o.NumberOfPlots,onChange:c,type:"number",placeholder:"5"}),e.jsx(m,{icon:e.jsx(g,{}),label:"Latitude",name:"Latitude",value:o.Latitude,onChange:c,placeholder:"e.g. 9.0000"}),e.jsx(m,{icon:e.jsx(g,{}),label:"Longitude",name:"Longitude",value:o.Longitude,onChange:c,placeholder:"e.g. 38.0000"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300",children:[e.jsx("input",{type:"checkbox",name:"IsActive",checked:!!o.IsActive,onChange:c,className:"rounded text-indigo-600 focus:ring-indigo-500"})," Active"]})}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>b(!1),className:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700",disabled:f,children:f?"Saving...":"Save"})]})]})}),e.jsx(q,{open:Y,onClose:()=>C(!1),title:`Update GPS for ${D?.FarmName}`,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Get or enter GPS coordinates in the form ",e.jsx("code",{children:"lat,lon"}),". Click ",e.jsx("strong",{children:"Get"})," to use your device location. The field is read-only."]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Coordinates (lat, lon)"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400",children:e.jsx(g,{})}),e.jsx("input",{name:"coords",value:M,onChange:xe,readOnly:!0,className:"block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white",placeholder:"e.g. 9.000000,38.000000"})]})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx("button",{type:"button",onClick:ge,className:"px-3 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300",disabled:z,children:z?"Getting...":"Get"})})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[e.jsx("button",{onClick:()=>C(!1),className:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300",children:"Cancel"}),e.jsx("button",{onClick:he,className:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700",disabled:f,children:f?"Updating...":"Update"})]})]})}),e.jsxs(Ie,{open:X,title:"Confirm Deletion",onClose:()=>L(!1),onConfirm:le,children:["Are you sure you want to delete farm ",T?.FarmName,"? This will mark it as inactive."]})]})}export{Te as default};
