import{G as T,u as _,r as n,j as e,P as G,ak as H,T as V,M as W,C as J}from"./index-gIg6QK8U.js";const K=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],Q=T("arrow-down",K);const X=[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]],Z=T("arrow-up",X);function b(m){return m&&(m.UserID||m.userId||m.UserId||m.id||m.ID)}function ae(){const{user:m,fetchWithAuth:u}=_(),[d,w]=n.useState([]),[O,y]=n.useState(!1),[P,o]=n.useState(null),[ee,B]=n.useState([]),[i,C]=n.useState({totalCount:0,currentPage:1,pageSize:25}),[U,S]=n.useState([]),[$,j]=n.useState(!1),[te,re]=n.useState({FormName:"",FormDescription:"",Path:"",Module:"",ParentFormID:null,IsActive:!0}),[k,M]=n.useState(!1),[a,c]=n.useState({open:!1,id:null,form:null,saving:!1}),[v,F]=n.useState({open:!1,id:null,title:"",message:"",processing:!1}),x=n.useRef(null),h=n.useRef(null),[D,f]=n.useState("idle"),[I,p]=n.useState("idle"),g=async(t=1)=>{y(!0);try{const r=await u({url:"/forms",method:"get",params:{page:t,pageSize:i.pageSize}}),s=r.data&&(r.data.data||r.data)||[],l=Array.isArray(s.items)?s.items:Array.isArray(s)?s:[];w(l),s.pagination?C(s.pagination):C(N=>({...N,currentPage:t,totalCount:l.length})),S(l.map(N=>N.FormID)),j(!1)}catch(r){console.error("fetchForms error",r),o({type:"error",text:r?.response?.data?.message||r.message||"Failed to load forms"})}finally{y(!1)}};n.useEffect(()=>{g(i.currentPage)},[]),n.useEffect(()=>()=>{try{x.current&&clearTimeout(x.current)}catch{}try{h.current&&clearTimeout(h.current)}catch{}},[]),n.useEffect(()=>{a.open||(x.current&&(clearTimeout(x.current),x.current=null),h.current&&(clearTimeout(h.current),h.current=null),f("idle"),p("idle"))},[a.open]);const q=async()=>{try{const t=await u({url:"/forms",method:"get",params:{page:1,pageSize:1e3}}),r=t.data&&(t.data.data||t.data)||[],s=Array.isArray(r.items)?r.items:Array.isArray(r)?r:[];B(s)}catch(t){console.warn("fetchParentOptions error",t)}};n.useEffect(()=>{q()},[]);const z=t=>{c({open:!0,id:t.FormID,form:{FormName:t.FormName,FormDescription:t.FormDescription||"",Path:t.FormPath||t.Path||"",Module:t.Module||"",ParentFormID:t.ParentFormID||null,IsActive:!!t.IsActive},saving:!1})},L=async()=>{const{id:t,form:r}=a;if(!r.FormName){o({type:"error",text:"Form name is required"});return}const s=b(m);if(!s){o({type:"error",text:"You must be signed in to update forms."});return}c(l=>({...l,saving:!0}));try{const l={FormName:r.FormName.trim(),FormDescription:(r.FormDescription||"").toString().trim(),Path:r.Path||null,Module:r.Module||null,ParentFormID:r.ParentFormID||null,IsActive:r.IsActive?1:0,UpdatedBy:s};await u({url:`/forms/${t}`,method:"patch",data:l}),o({type:"success",text:"Form updated"}),c({open:!1,id:null,form:null,saving:!1}),await g()}catch(l){console.error("updateForm error",l),o({type:"error",text:l?.response?.data?.message||l.message||"Failed to update form"}),c(N=>({...N,saving:!1}))}},R=t=>{F({open:!0,id:t.FormID,title:`Delete ${t.FormName}`,message:"Soft-delete this form?",processing:!1})},Y=async()=>{if(v.open){F(t=>({...t,processing:!0}));try{const t=b(m);if(!t)throw new Error("You must be signed in to delete forms.");await u({url:`/forms/${v.id}/delete`,method:"post",data:{DeletedBy:t}}),o({type:"success",text:"Form deleted"}),await g()}catch(t){console.error("deleteForm error",t),o({type:"error",text:t?.response?.data?.message||t.message||"Failed to delete form"})}finally{F({open:!1,id:null,title:"",message:"",processing:!1})}}},A=async(t,r=null)=>{if(!t)return!1;try{return(await u({url:"/forms/check-name",method:"get",params:{FormName:t,ExcludeFormID:r}}))?.data?.data?.exists||!1}catch{return!1}},E=async(t,r=null)=>{if(!t)return!1;try{return(await u({url:"/forms/check-path",method:"get",params:{Path:t,ExcludeFormID:r}}))?.data?.data?.exists||!1}catch{return!1}};return e.jsxs("div",{className:"space-y-6 h-full",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-slate-900",children:"Forms"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Manage application forms and navigation paths."})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>c({open:!0,id:null,form:{FormName:"",FormDescription:"",Path:"",Module:"",ParentFormID:null,IsActive:!0},saving:!1}),className:"inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded-md text-sm",children:[" ",e.jsx(G,{className:"h-4 w-4"})," New Form"]})})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm overflow-auto h-full",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"All Forms"}),e.jsx("div",{className:"text-sm text-slate-500",children:O?"Loading...":`${i.totalCount||d.length||0} forms`})]}),e.jsx("div",{className:"w-full overflow-auto",children:!d||d.length===0?e.jsx("div",{className:"h-48 flex items-center justify-center",children:e.jsx("div",{className:"text-slate-500",children:"No forms found."})}):e.jsxs("table",{className:"w-full text-sm table-auto text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-slate-600",children:[e.jsx("th",{className:"p-3",children:"Name"}),e.jsx("th",{className:"p-3",children:"Path"}),e.jsx("th",{className:"p-3",children:"Module"}),e.jsx("th",{className:"p-3",children:"Active"}),e.jsx("th",{className:"p-3",children:"Actions"})]})}),e.jsx("tbody",{children:d.map((t,r)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3 align-top font-medium text-slate-800",children:t.FormName}),e.jsx("td",{className:"p-3 align-top text-slate-600",children:t.FormPath||t.Path||"-"}),e.jsx("td",{className:"p-3 align-top text-slate-600",children:t.Module||"-"}),e.jsx("td",{className:"p-3 align-top",children:t.IsActive?e.jsx("span",{className:"text-green-600",children:"Yes"}):e.jsx("span",{className:"text-red-600",children:"No"})}),e.jsx("td",{className:"p-3 align-top",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>z(t),className:"p-2 rounded-md hover:bg-gray-100",title:"Edit",children:e.jsx(H,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>R(t),className:"p-2 rounded-md hover:bg-red-50 text-red-600",title:"Delete",children:e.jsx(V,{className:"h-4 w-4"})})]})}),e.jsx("td",{className:"p-3 align-top",children:e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("button",{disabled:r===0,onClick:()=>{const s=[...d];[s[r-1],s[r]]=[s[r],s[r-1]],w(s),S(s.map(l=>l.FormID)),j(!0)},className:"p-1 rounded hover:bg-gray-100",title:"Move up",children:e.jsx(Z,{className:"h-4 w-4"})}),e.jsx("button",{disabled:r===d.length-1,onClick:()=>{const s=[...d];[s[r+1],s[r]]=[s[r],s[r+1]],w(s),S(s.map(l=>l.FormID)),j(!0)},className:"p-1 rounded hover:bg-gray-100",title:"Move down",children:e.jsx(Q,{className:"h-4 w-4"})})]})})]},t.FormID))})]})}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{i.currentPage>1&&g(i.currentPage-1)},className:"px-3 py-1 border rounded",children:"Prev"}),e.jsxs("span",{className:"text-sm text-slate-600",children:["Page ",i.currentPage," / ",Math.max(1,Math.ceil((i.totalCount||d.length)/i.pageSize))]}),e.jsx("button",{onClick:()=>{const t=Math.max(1,Math.ceil((i.totalCount||d.length)/i.pageSize));i.currentPage<t&&g(i.currentPage+1)},className:"px-3 py-1 border rounded",children:"Next"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{disabled:!$,onClick:async()=>{try{y(!0);const t={OrderedFormIDs:U,UpdatedBy:b(m)};await u({url:"/forms/reorder",method:"post",data:t}),o({type:"success",text:"Order saved"}),j(!1),await g(i.currentPage)}catch(t){console.error("save order error",t),o({type:"error",text:t?.response?.data?.message||t.message||"Failed to save order"})}finally{y(!1)}},className:"px-3 py-1 bg-indigo-600 text-white rounded disabled:opacity-50",children:"Save Order"})})]})]}),e.jsx(W,{open:a.open,onClose:()=>c({open:!1,id:null,form:null}),title:a.form?`Edit: ${a.form.FormName}`:"New Form",children:a.form&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-slate-700 block mb-1",children:"Form Name"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:a.form.FormName,onChange:t=>{const r=t.target.value;if(c(s=>({...s,form:{...s.form,FormName:r}})),x.current&&clearTimeout(x.current),!r||!r.toString().trim()){f("idle");return}f("validating"),x.current=setTimeout(async()=>{try{const s=await A(r.toString().trim(),a.id);f(s?"invalid":"valid")}catch{f("idle")}},400)},onBlur:async t=>{const r=(t.target.value||"").toString().trim();if(!r)return;f("validating");const s=await A(r,a.id);f(s?"invalid":"valid"),s&&o({type:"error",text:"Form name already exists"})},className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"}),e.jsxs("div",{className:"min-w-[90px]",children:[D==="validating"&&e.jsx("div",{className:"text-sm text-gray-500",children:"Checking..."}),D==="valid"&&e.jsx("div",{className:"text-sm text-green-600",children:"Available"}),D==="invalid"&&e.jsx("div",{className:"text-sm text-red-600",children:"Taken"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-slate-700 block mb-1",children:"Description"}),e.jsx("textarea",{value:a.form.FormDescription,onChange:t=>c(r=>({...r,form:{...r.form,FormDescription:t.target.value}})),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm",rows:3})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-slate-700 block mb-1",children:"Path"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:a.form.Path,onChange:t=>{const r=t.target.value;if(c(s=>({...s,form:{...s.form,Path:r}})),h.current&&clearTimeout(h.current),!r||!r.toString().trim()){p("idle");return}p("validating"),h.current=setTimeout(async()=>{try{const s=await E(r.toString().trim(),a.id);p(s?"invalid":"valid")}catch{p("idle")}},400)},onBlur:async t=>{const r=(t.target.value||"").toString().trim();if(!r)return;p("validating");const s=await E(r,a.id);p(s?"invalid":"valid"),s&&o({type:"error",text:"Path already in use"})},className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"}),e.jsxs("div",{className:"min-w-[90px]",children:[I==="validating"&&e.jsx("div",{className:"text-sm text-gray-500",children:"Checking..."}),I==="valid"&&e.jsx("div",{className:"text-sm text-green-600",children:"Available"}),I==="invalid"&&e.jsx("div",{className:"text-sm text-red-600",children:"Taken"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-left text-sm font-medium text-slate-700 block mb-1",children:"Module"}),e.jsx("input",{value:a.form.Module,onChange:t=>c(r=>({...r,form:{...r.form,Module:t.target.value}})),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!a.form.IsActive,onChange:t=>c(r=>({...r,form:{...r.form,IsActive:t.target.checked}})),className:"form-checkbox h-4 w-4"}),e.jsx("span",{children:"Active"})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>c({open:!1,id:null,form:null}),className:"px-4 py-2 rounded border",children:"Cancel"}),e.jsx("button",{onClick:async()=>{a.id?await L():await(async()=>{const t=b(m);if(!t){o({type:"error",text:"You must be signed in to create forms."});return}if(!a.form.FormName||!(a.form.FormName||"").toString().trim()){o({type:"error",text:"Form name is required"});return}if(!a.form.Path||!(a.form.Path||"").toString().trim()){o({type:"error",text:"Form path is required"});return}if(!a.form.Module||!(a.form.Module||"").toString().trim()){o({type:"error",text:"Module is required"});return}const r={FormName:(a.form.FormName||"").toString().trim(),FormDescription:(a.form.FormDescription||"").toString().trim(),Path:(a.form.Path||"").toString().trim(),Module:(a.form.Module||"").toString().trim(),ParentFormID:a.form.ParentFormID||null,IsActive:a.form.IsActive?1:0,CreatedBy:t};M(!0);try{await u({url:"/forms",method:"post",data:r}),o({type:"success",text:"Form created"}),c({open:!1,id:null,form:null}),await g()}catch(s){console.error("createForm error",s),o({type:"error",text:s?.response?.data?.message||s.message||"Failed to create form"})}finally{M(!1)}})()},disabled:k,className:"px-4 py-2 bg-indigo-600 text-white rounded",children:k?"Saving...":a.id?"Update":"Create"})]}),P&&e.jsx("div",{className:`text-sm ${P.type==="error"?"text-red-600":"text-green-600"}`,children:P.text})]})}),e.jsx(J,{open:v.open,title:v.title,message:v.message,onCancel:()=>F({open:!1,id:null,title:"",message:"",processing:!1}),onConfirm:Y,confirmLabel:"Yes",cancelLabel:"No",loading:v.processing})]})}export{ae as default};
