import{u as J,r as d,j as e,P as K,ak as Q,T as X,M as D,C as Z}from"./index-gIg6QK8U.js";const k=r=>!r||typeof r!="string"?!1:/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(r);function y(r){return r&&(r.UserID||r.userId||r.UserId||r.id||r.ID)}function ee(){const{user:r,fetchWithAuth:x}=J(),[N,S]=d.useState([]),[v,B]=d.useState([]),[P,F]=d.useState([]),[V,w]=d.useState(!1),[R,n]=d.useState(null),[b,Y]=d.useState({totalCount:0,currentPage:1,pageSize:25}),[a,p]=d.useState({RoleID:"",PermissionID:"",CanView:!0,CanCreate:!1,CanEdit:!1,CanDelete:!1,CanApprove:!1,CanExport:!1,IsActive:!0}),[M,A]=d.useState(!1),[i,c]=d.useState({open:!1,id:null,form:null,saving:!1}),[f,I]=d.useState({open:!1,id:null,title:"",message:"",processing:!1}),[m,h]=d.useState({open:!1,RoleID:"",selectedPermissions:[],processing:!1}),[C,g]=d.useState({open:!1,sourceRoleId:"",targetRoleId:"",processing:!1}),U=async()=>{try{const[s,t]=await Promise.all([x({url:"/roles",method:"get",params:{page:1,pageSize:1e3},redirectOnFail:!1}),x({url:"/permissions",method:"get",params:{page:1,pageSize:1e3},redirectOnFail:!1})]),o=s?.data?.data?.items||s?.data?.items||[],l=t?.data?.data?.items||t?.data?.items||[];B(o),F(l)}catch(s){console.error("fetchLists error",s),n({type:"error",text:s?.response?.data?.message||s.message||"Failed to load roles/permissions"})}},u=async(s=1)=>{w(!0);try{const t=await x({url:"/role-permissions",method:"get",params:{page:s,pageSize:b.pageSize}}),o=t?.data?.data||t?.data||{items:[]},l=o.items||[];S(l),Y(o.pagination||{totalCount:l.length||0,currentPage:s,pageSize:b.pageSize})}catch(t){console.error("fetchItems error",t),n({type:"error",text:t?.response?.data?.message||t.message||"Failed to load role-permissions"})}finally{w(!1)}};d.useEffect(()=>{U(),u(1)},[]);const E=()=>p({RoleID:"",PermissionID:"",CanView:!0,CanCreate:!1,CanEdit:!1,CanDelete:!1,CanApprove:!1,CanExport:!1,IsActive:!0}),$=async s=>{s.preventDefault(),n(null);const t=y(r);if(!t){n({type:"error",text:"You must be signed in to create role-permissions."});return}if(!a.RoleID||!a.PermissionID){n({type:"error",text:"Role and Permission are required."});return}if(!k(a.RoleID)){n({type:"error",text:"RoleID must be a valid GUID"});return}if(!k(a.PermissionID)){n({type:"error",text:"PermissionID must be a valid GUID"});return}A(!0);try{const o={RoleID:a.RoleID,PermissionID:a.PermissionID,CanView:a.CanView?1:0,CanCreate:a.CanCreate?1:0,CanEdit:a.CanEdit?1:0,CanDelete:a.CanDelete?1:0,CanApprove:a.CanApprove?1:0,CanExport:a.CanExport?1:0,IsActive:a.IsActive?1:0,CreatedBy:t};await x({url:"/role-permissions",method:"post",data:o}),n({type:"success",text:"Permission assigned to role"}),E(),await u(1)}catch(o){console.error("createRolePermission error",o),n({type:"error",text:o?.response?.data?.message||o.message||"Failed to assign permission"})}finally{A(!1)}},z=s=>{c({open:!0,id:s.RolePermissionID,form:{CanView:!!s.CanView,CanCreate:!!s.CanCreate,CanEdit:!!s.CanEdit,CanDelete:!!s.CanDelete,CanApprove:!!s.CanApprove,CanExport:!!s.CanExport,IsActive:!!s.IsActive},saving:!1})},L=async()=>{const{id:s,form:t}=i,o=y(r);if(!o){n({type:"error",text:"You must be signed in to update."});return}c(l=>({...l,saving:!0}));try{const l={CanView:t.CanView?1:0,CanCreate:t.CanCreate?1:0,CanEdit:t.CanEdit?1:0,CanDelete:t.CanDelete?1:0,CanApprove:t.CanApprove?1:0,CanExport:t.CanExport?1:0,IsActive:t.IsActive?1:0,UpdatedBy:o};await x({url:`/role-permissions/${s}`,method:"patch",data:l}),n({type:"success",text:"Role-permission updated"}),c({open:!1,id:null,form:null,saving:!1}),await u(b.currentPage)}catch(l){console.error("updateRolePermission error",l),n({type:"error",text:l?.response?.data?.message||l.message||"Failed to update"}),c(j=>({...j,saving:!1}))}},T=s=>{I({open:!0,id:s.RolePermissionID,title:"Delete assignment",message:`Remove permission ${s.PermissionCode||""} from role ${s.RoleName||""}?`,processing:!1})},G=async()=>{if(f.open){I(s=>({...s,processing:!0}));try{const s=y(r);if(!s)throw new Error("You must be signed in to delete.");await x({url:`/role-permissions/${f.id}`,method:"delete",data:{UpdatedBy:s}}),n({type:"success",text:"Assignment removed"}),await u(b.currentPage)}catch(s){console.error("deleteRolePermission error",s),n({type:"error",text:s?.response?.data?.message||s.message||"Failed to delete"})}finally{I({open:!1,id:null,title:"",message:"",processing:!1})}}},O=(s="")=>h({open:!0,RoleID:s,selectedPermissions:[],processing:!1}),q=async()=>{if(!m.RoleID||!m.selectedPermissions.length){n({type:"error",text:"Select a role and at least one permission"});return}const s=y(r);if(!s){n({type:"error",text:"You must be signed in"});return}if(!k(m.RoleID)){n({type:"error",text:"RoleID must be a valid GUID"});return}if(m.selectedPermissions.find(o=>!k(o))){n({type:"error",text:"One or more selected permissions are invalid"});return}h(o=>({...o,processing:!0}));try{const o={RoleID:m.RoleID,PermissionIDs:m.selectedPermissions,CreatedBy:s},l=await x({url:"/role-permissions/bulk-assign",method:"post",data:o});n({type:"success",text:`Assigned ${l?.data?.data?.assigned?.length||0} permissions`}),h({open:!1,RoleID:"",selectedPermissions:[],processing:!1}),await u(1)}catch(o){console.error("bulkAssign error",o),n({type:"error",text:o?.response?.data?.message||o.message||"Bulk assign failed"}),h(l=>({...l,processing:!1}))}},W=()=>g({open:!0,sourceRoleId:"",targetRoleId:"",processing:!1}),H=async()=>{const{sourceRoleId:s,targetRoleId:t}=C;if(!s||!t){n({type:"error",text:"Select both source and target roles"});return}const o=y(r);if(!o){n({type:"error",text:"You must be signed in"});return}g(l=>({...l,processing:!0}));try{const j=await x({url:"/role-permissions/copy",method:"post",data:{SourceRoleID:s,TargetRoleID:t,CreatedBy:o}});n({type:"success",text:`Copied ${j?.data?.data?.copiedCount||0} permissions`}),g({open:!1,sourceRoleId:"",targetRoleId:"",processing:!1}),await u(1)}catch(l){console.error("copyRolePermissions error",l),n({type:"error",text:l?.response?.data?.message||l.message||"Copy failed"}),g(j=>({...j,processing:!1}))}};return e.jsxs("div",{className:"space-y-6 h-full",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-slate-900",children:"Role - Permission Assignments"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Assign permissions to roles and manage role-permission flags."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>u(1),className:"px-3 py-2 bg-white border rounded-md text-sm",children:"Refresh"}),e.jsx("button",{onClick:()=>O(""),className:"px-3 py-2 bg-white border rounded-md text-sm",children:"Bulk Assign"}),e.jsx("button",{onClick:W,className:"px-3 py-2 bg-white border rounded-md text-sm",children:"Copy From Role"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white p-6 rounded-lg shadow-sm text-left",children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"Assign Permission to Role"}),e.jsxs("form",{onSubmit:$,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Role"}),e.jsxs("select",{value:a.RoleID,onChange:s=>p({...a,RoleID:s.target.value}),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm",children:[e.jsx("option",{value:"",children:"-- Select Role --"}),v.map(s=>e.jsx("option",{value:s.RoleID,children:s.RoleName},s.RoleID))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Permission"}),e.jsxs("select",{value:a.PermissionID,onChange:s=>p({...a,PermissionID:s.target.value}),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm",children:[e.jsx("option",{value:"",children:"-- Select Permission --"}),P.map(s=>e.jsxs("option",{value:s.PermissionID,children:[s.PermissionCode," — ",s.PermissionName]},s.PermissionID))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:a.CanView,onChange:s=>p({...a,CanView:s.target.checked}),className:"form-checkbox"})," View"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:a.CanCreate,onChange:s=>p({...a,CanCreate:s.target.checked}),className:"form-checkbox"})," Create"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:a.CanEdit,onChange:s=>p({...a,CanEdit:s.target.checked}),className:"form-checkbox"})," Edit"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:a.CanDelete,onChange:s=>p({...a,CanDelete:s.target.checked}),className:"form-checkbox"})," Delete"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:a.CanApprove,onChange:s=>p({...a,CanApprove:s.target.checked}),className:"form-checkbox"})," Approve"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:a.CanExport,onChange:s=>p({...a,CanExport:s.target.checked}),className:"form-checkbox"})," Export"]})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:a.IsActive,onChange:s=>p({...a,IsActive:s.target.checked}),className:"form-checkbox"})," Active"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"submit",disabled:M,className:"inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md",children:[" ",e.jsx(K,{className:"h-4 w-4"})," Assign"]}),e.jsx("button",{type:"button",onClick:E,className:"px-3 py-2 border rounded-md",children:"Reset"})]}),R&&e.jsx("div",{className:`text-sm ${R.type==="error"?"text-red-600":"text-green-600"}`,children:R.text})]})]}),e.jsxs("div",{className:"lg:col-span-2 bg-white p-6 rounded-lg shadow-sm overflow-auto text-left",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Assignments"}),e.jsx("div",{className:"text-sm text-slate-500",children:V?"Loading...":`${b.totalCount||0} assignments`})]}),e.jsx("div",{className:"w-full overflow-auto",children:e.jsxs("table",{className:"w-full text-sm table-auto text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-slate-600",children:[e.jsx("th",{className:"p-3",children:"Role"}),e.jsx("th",{className:"p-3",children:"Permission"}),e.jsx("th",{className:"p-3",children:"Flags"}),e.jsx("th",{className:"p-3",children:"Active"}),e.jsx("th",{className:"p-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[N&&N.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-3 text-slate-500",children:"No assignments found."})}),N&&N.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3 align-top font-medium text-slate-800",children:s.RoleName}),e.jsxs("td",{className:"p-3 align-top text-slate-600",children:[s.PermissionCode," ",e.jsx("div",{className:"text-xs text-slate-500",children:s.PermissionName})]}),e.jsxs("td",{className:"p-3 align-top text-xs text-slate-600",children:["V:",s.CanView?"Y":"N"," C:",s.CanCreate?"Y":"N"," E:",s.CanEdit?"Y":"N"," D:",s.CanDelete?"Y":"N"]}),e.jsx("td",{className:"p-3 align-top",children:s.IsActive?e.jsx("span",{className:"text-green-600",children:"Yes"}):e.jsx("span",{className:"text-red-600",children:"No"})}),e.jsx("td",{className:"p-3 align-top",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>z(s),className:"p-2 rounded-md hover:bg-gray-100",title:"Edit",children:e.jsx(Q,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>T(s),className:"p-2 rounded-md hover:bg-red-50 text-red-600",title:"Delete",children:e.jsx(X,{className:"h-4 w-4"})})]})})]},s.RolePermissionID))]})]})})]})]}),e.jsx(D,{open:i.open,onClose:()=>c({open:!1,id:null,form:null}),title:(i.form,"Edit Assignment"),children:i.form&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:i.form.CanView,onChange:s=>c(t=>({...t,form:{...t.form,CanView:s.target.checked}})),className:"form-checkbox"})," View"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:i.form.CanCreate,onChange:s=>c(t=>({...t,form:{...t.form,CanCreate:s.target.checked}})),className:"form-checkbox"})," Create"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:i.form.CanEdit,onChange:s=>c(t=>({...t,form:{...t.form,CanEdit:s.target.checked}})),className:"form-checkbox"})," Edit"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:i.form.CanDelete,onChange:s=>c(t=>({...t,form:{...t.form,CanDelete:s.target.checked}})),className:"form-checkbox"})," Delete"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:i.form.CanApprove,onChange:s=>c(t=>({...t,form:{...t.form,CanApprove:s.target.checked}})),className:"form-checkbox"})," Approve"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:i.form.CanExport,onChange:s=>c(t=>({...t,form:{...t.form,CanExport:s.target.checked}})),className:"form-checkbox"})," Export"]})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!i.form.IsActive,onChange:s=>c(t=>({...t,form:{...t.form,IsActive:s.target.checked}})),className:"form-checkbox"})," Active"]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>c({open:!1,id:null,form:null}),className:"px-4 py-2 rounded border",children:"Cancel"}),e.jsx("button",{onClick:L,disabled:i.saving,className:"px-4 py-2 bg-indigo-600 text-white rounded",children:i.saving?"Saving...":"Update"})]})]})}),e.jsx(D,{open:m.open,onClose:()=>h({open:!1,RoleID:"",selectedPermissions:[],processing:!1}),title:m.RoleID?"Bulk assign to role":"Bulk assign permissions",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Role"}),e.jsxs("select",{value:m.RoleID,onChange:s=>h(t=>({...t,RoleID:s.target.value})),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm",children:[e.jsx("option",{value:"",children:"-- Select Role --"}),v.map(s=>e.jsx("option",{value:s.RoleID,children:s.RoleName},s.RoleID))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Permissions"}),e.jsx("div",{className:"max-h-56 overflow-auto border rounded p-2",children:P.map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm py-1",children:[e.jsx("input",{type:"checkbox",checked:m.selectedPermissions.includes(s.PermissionID),onChange:t=>h(o=>({...o,selectedPermissions:t.target.checked?[...o.selectedPermissions,s.PermissionID]:o.selectedPermissions.filter(l=>l!==s.PermissionID)})),className:"form-checkbox"}),e.jsxs("span",{children:[s.PermissionCode," — ",s.PermissionName]})]},s.PermissionID))})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>h({open:!1,RoleID:"",selectedPermissions:[],processing:!1}),className:"px-4 py-2 rounded border",children:"Cancel"}),e.jsx("button",{onClick:q,disabled:m.processing,className:"px-4 py-2 bg-indigo-600 text-white rounded",children:m.processing?"Processing...":"Assign"})]})]})}),e.jsx(D,{open:C.open,onClose:()=>g({open:!1,sourceRoleId:"",targetRoleId:"",processing:!1}),title:"Copy Role Permissions",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Source Role"}),e.jsxs("select",{value:C.sourceRoleId,onChange:s=>g(t=>({...t,sourceRoleId:s.target.value})),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm",children:[e.jsx("option",{value:"",children:"-- Source Role --"}),v.map(s=>e.jsx("option",{value:s.RoleID,children:s.RoleName},s.RoleID))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Target Role"}),e.jsxs("select",{value:C.targetRoleId,onChange:s=>g(t=>({...t,targetRoleId:s.target.value})),className:"w-full px-3 py-2 border border-gray-200 rounded-md text-sm",children:[e.jsx("option",{value:"",children:"-- Target Role --"}),v.map(s=>e.jsx("option",{value:s.RoleID,children:s.RoleName},s.RoleID))]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>g({open:!1,sourceRoleId:"",targetRoleId:"",processing:!1}),className:"px-4 py-2 rounded border",children:"Cancel"}),e.jsx("button",{onClick:H,disabled:C.processing,className:"px-4 py-2 bg-indigo-600 text-white rounded",children:C.processing?"Processing...":"Copy"})]})]})}),e.jsx(Z,{open:f.open,title:f.title,message:f.message,onCancel:()=>I({open:!1,id:null,title:"",message:"",processing:!1}),onConfirm:G,confirmLabel:"Yes",cancelLabel:"No",loading:f.processing})]})}export{ee as default};
