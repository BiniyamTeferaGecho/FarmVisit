import{u as W,r,j as s,R as X,P as _,E as G,al as J,S as K,T as Q,M as V,C as Y}from"./index-gIg6QK8U.js";const j=n=>n&&(n.UserID||n.userId||n.UserId||n.id||n.ID),ee=()=>{const{user:n,fetchWithAuth:i}=W(),[k,D]=r.useState([]),[F,N]=r.useState(!0),[u,o]=r.useState(null),[c,I]=r.useState({totalCount:0,currentPage:1,pageSize:15}),[v,P]=r.useState([]),[C,S]=r.useState([]),[l,d]=r.useState({open:!1,data:null,saving:!1}),[m,g]=r.useState({open:!1,data:null,processing:!1}),[h,R]=r.useState(""),[p,w]=r.useState(new Set),[y,A]=r.useState({CanAccess:1,CanCreate:0,CanEdit:0,CanDelete:0,CanApprove:0}),x=async(e=1)=>{N(!0),o(null);try{const a=await i({url:"/form-permissions",params:{page:e,pageSize:c.pageSize}}),t=a.data?.data||a.data||{items:[]};D(t.items||[]),t.pagination&&I(t.pagination)}catch(a){o({type:"error",text:a.message||"Failed to load permissions"})}finally{N(!1)}},E=async()=>{try{const[e,a]=await Promise.all([i({url:"/forms",params:{pageSize:1e3}}),i({url:"/roles",params:{pageSize:1e3}})]);P(e.data?.data?.items||e.data?.items||[]),S(a.data?.data?.items||a.data?.items||[])}catch(e){console.error("Failed to fetch forms or roles",e)}};r.useEffect(()=>{x(1),E()},[]);const B=async()=>{const e=j(n);if(!e){o({type:"error",text:"Authentication Error: User ID not found."});return}const{data:a}=l;if(!a.FormID||!a.RoleID){o({type:"error",text:"Form and Role are required."});return}d(b=>({...b,saving:!0}));const t=!!a.FormPermissionID,f=t?`/form-permissions/${a.FormPermissionID}`:"/form-permissions",O=t?"PATCH":"POST",q=t?{...a,UpdatedBy:e}:{...a,CreatedBy:e};try{await i({url:f,method:O,data:q}),o({type:"success",text:`Permission ${t?"updated":"created"} successfully`}),d({open:!1,data:null,saving:!1}),x(c.currentPage)}catch(b){o({type:"error",text:b.message||`Failed to ${t?"update":"create"} permission`}),d(H=>({...H,saving:!1}))}},M=async()=>{const e=j(n),{data:a}=m;if(a?.FormPermissionID){g(t=>({...t,processing:!0}));try{await i({url:`/form-permissions/${a.FormPermissionID}`,method:"DELETE",data:{UpdatedBy:e}}),o({type:"success",text:"Permission deleted successfully"}),g({open:!1,data:null,processing:!1}),x(c.currentPage)}catch(t){o({type:"error",text:t.message||"Failed to delete permission"}),g(f=>({...f,processing:!1}))}}},U=async()=>{const e=j(n);if(!h||p.size===0){o({type:"error",text:"Please select a role and at least one form."});return}try{const a={RoleID:h,FormPermissions:Array.from(p).map(t=>({FormID:t,...y})),CreatedBy:e};await i({url:"/form-permissions/bulk-assign",method:"POST",data:a}),o({type:"success",text:"Bulk assign successful"}),w(new Set),x(c.currentPage)}catch(a){o({type:"error",text:a.message||"Bulk assign failed"})}},$=()=>{d({open:!0,data:{FormID:"",RoleID:"",CanAccess:!0,CanCreate:!1,CanEdit:!1,CanDelete:!1,CanApprove:!1},saving:!1})},z=e=>{d({open:!0,data:e,saving:!1})},T=e=>{g({open:!0,data:e,title:"Delete Permission",message:`Are you sure you want to delete the permission for "${e.RoleName}" on "${e.FormName}"?`,processing:!1})},L=e=>{const a=new Set(p);a.has(e)?a.delete(e):a.add(e),w(a)};return s.jsxs("div",{className:"p-6 bg-gray-50 dark:bg-gray-900 min-h-screen",children:[s.jsxs("header",{className:"flex items-center justify-between mb-6",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-800 dark:text-white",children:"Form Permissions"}),s.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Manage form access for different roles."})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:()=>x(c.currentPage),className:"p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors",children:s.jsx(X,{className:"h-5 w-5 text-gray-600 dark:text-gray-300"})}),s.jsxs("button",{onClick:$,className:"inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold shadow-sm hover:bg-indigo-700 focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:[s.jsx(_,{className:"h-4 w-4"})," New Permission"]})]})]}),u&&s.jsx("div",{className:`p-4 mb-4 rounded-md text-sm ${u.type==="error"?"bg-red-100 text-red-800":"bg-green-100 text-green-800"}`,children:u.text}),s.jsx("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md overflow-hidden",children:s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full text-sm text-left text-gray-500 dark:text-gray-400",children:[s.jsx("thead",{className:"text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400",children:s.jsx("tr",{children:["Form","Role","Access","Create","Edit","Delete","Approve","Actions"].map(e=>s.jsx("th",{scope:"col",className:"px-6 py-3",children:e},e))})}),s.jsx("tbody",{children:F?Array.from({length:5}).map((e,a)=>s.jsx("tr",{className:"bg-white border-b dark:bg-gray-800 dark:border-gray-700",children:s.jsx("td",{colSpan:"8",className:"px-6 py-4",children:s.jsx("div",{className:"h-4 bg-gray-200 rounded dark:bg-gray-700 w-full animate-pulse"})})},a)):k.map(e=>s.jsxs("tr",{className:"bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600",children:[s.jsx("td",{className:"px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap",children:e.FormName}),s.jsx("td",{className:"px-6 py-4",children:e.RoleName}),[e.CanAccess,e.CanCreate,e.CanEdit,e.CanDelete,e.CanApprove].map((a,t)=>s.jsx("td",{className:"px-6 py-4",children:a?s.jsx(G,{className:"h-5 w-5 text-green-500"}):s.jsx(J,{className:"h-5 w-5 text-red-500"})},t)),s.jsx("td",{className:"px-6 py-4",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:()=>z(e),className:"p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700",title:"Edit",children:s.jsx(K,{className:"h-4 w-4 text-gray-600 dark:text-gray-300"})}),s.jsx("button",{onClick:()=>T(e),className:"p-2 rounded-md hover:bg-red-100 dark:hover:bg-red-800",title:"Delete",children:s.jsx(Q,{className:"h-4 w-4 text-red-500"})})]})})]},e.FormPermissionID))})]})})}),s.jsxs("section",{className:"bg-white dark:bg-gray-800 mt-6 p-6 rounded-xl shadow-md",children:[s.jsx("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:"Bulk Assign Permissions"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Role"}),s.jsxs("select",{value:h,onChange:e=>R(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[s.jsx("option",{value:"",children:"-- Select Role --"}),C.map(e=>s.jsx("option",{value:e.RoleID,children:e.RoleName},e.RoleID))]})]}),s.jsxs("div",{className:"md:col-span-2 space-y-2",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Forms"}),s.jsx("div",{className:"max-h-48 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-md p-3 grid grid-cols-2 gap-3",children:v.map(e=>s.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300",children:[s.jsx("input",{type:"checkbox",checked:p.has(e.FormID),onChange:()=>L(e.FormID),className:"h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"}),e.FormName]},e.FormID))})]})]}),s.jsx("div",{className:"mt-4 flex flex-wrap items-center gap-4",children:Object.keys(y).map(e=>s.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300",children:[s.jsx("input",{type:"checkbox",checked:!!y[e],onChange:a=>A(t=>({...t,[e]:a.target.checked?1:0})),className:"h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"}),e.replace("Can","")]},e))}),s.jsx("div",{className:"mt-6",children:s.jsx("button",{onClick:U,className:"px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold shadow-sm hover:bg-indigo-700",children:"Assign Permissions"})})]}),s.jsx(V,{open:l.open,onClose:()=>d({open:!1,data:null}),title:l.data?.FormPermissionID?"Edit Permission":"New Permission",children:l.data&&s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Form"}),s.jsxs("select",{value:l.data.FormID||"",onChange:e=>d(a=>({...a,data:{...a.data,FormID:e.target.value}})),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500",children:[s.jsx("option",{value:"",children:"-- Select Form --"}),v.map(e=>s.jsx("option",{value:e.FormID,children:e.FormName},e.FormID))]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Role"}),s.jsxs("select",{value:l.data.RoleID||"",onChange:e=>d(a=>({...a,data:{...a.data,RoleID:e.target.value}})),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500",children:[s.jsx("option",{value:"",children:"-- Select Role --"}),C.map(e=>s.jsx("option",{value:e.RoleID,children:e.RoleName},e.RoleID))]})]}),s.jsx("div",{className:"grid grid-cols-2 gap-4 pt-2",children:["CanAccess","CanCreate","CanEdit","CanDelete","CanApprove"].map(e=>s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:!!l.data[e],onChange:a=>d(t=>({...t,data:{...t.data,[e]:a.target.checked}})),className:"h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"}),e.replace("Can","")]},e))}),s.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[s.jsx("button",{onClick:()=>d({open:!1,data:null}),className:"px-4 py-2 rounded-md border border-gray-300 text-sm font-medium hover:bg-gray-50",children:"Cancel"}),s.jsx("button",{onClick:B,disabled:l.saving,className:"px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium shadow-sm hover:bg-indigo-700 disabled:bg-indigo-300",children:l.saving?"Saving...":l.data.FormPermissionID?"Update":"Create"})]})]})}),s.jsx(Y,{open:m.open,title:m.title,message:m.message,onCancel:()=>g({open:!1,data:null}),onConfirm:M,confirmLabel:"Delete",cancelLabel:"Cancel",loading:m.processing})]})};export{ee as default};
