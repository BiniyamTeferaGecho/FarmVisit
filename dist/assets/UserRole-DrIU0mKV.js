import{u as G,r as n,j as e,P as A,ak as H,T as J,M as E,C as K}from"./index-gIg6QK8U.js";function N(o){return o&&(o.UserID||o.userId||o.UserId||o.id||o.ID)}function Q(){const{user:o,fetchWithAuth:x}=G(),[g,w]=n.useState([]),[C,y]=n.useState(!1),[f,l]=n.useState(null),[v,k]=n.useState({totalCount:0,currentPage:1,pageSize:25}),[I,S]=n.useState([]),[R,F]=n.useState([]),[r,u]=n.useState({UserID:"",RoleID:"",EffectiveFrom:"",EffectiveTo:"",IsActive:!0}),[T,D]=n.useState(!1),[c,i]=n.useState({open:!1,id:null,form:null,saving:!1}),[p,b]=n.useState({open:!1,id:null,title:"",message:"",processing:!1}),[h,m]=n.useState({open:!1,UserID:"",RoleAssignments:[],processing:!1}),j=async(s=1)=>{y(!0);try{const t=await x({url:"/user-roles",method:"get",params:{page:s,pageSize:v.pageSize}}),a=t.data&&t.data.data?t.data.data:t.data||[];w(a.items||t.data||a||[]),k(d=>({...d,currentPage:s,totalCount:t.data&&t.data.totalCount||a.totalCount||a.length||0}))}catch(t){console.error("fetchUserRoles error",t),l({type:"error",text:t?.response?.data?.message||t.message||"Failed to load user roles"})}finally{y(!1)}},P=async()=>{try{const s=await x({url:"/users",method:"get",params:{page:1,pageSize:1e3}}),t=s&&s.data?s.data:null;let a=[];t?Array.isArray(t)?a=t:t.data&&Array.isArray(t.data)?a=t.data:t.data&&t.data.items&&Array.isArray(t.data.items)?a=t.data.items:t.items&&Array.isArray(t.items)?a=t.items:a=[]:a=[],S(a)}catch(s){console.warn("fetchUsers",s)}},B=async()=>{try{const s=await x({url:"/roles",method:"get",params:{page:1,pageSize:1e3}}),t=s.data&&s.data.data?s.data.data:s.data||{items:[]};F(t.items||[])}catch(s){console.warn("fetchRoles",s)}};n.useEffect(()=>{j(1),P(),B()},[]);const U=()=>u({UserID:"",RoleID:"",EffectiveFrom:"",EffectiveTo:"",IsActive:!0}),M=async s=>{if(s.preventDefault(),l(null),!r.UserID||!r.RoleID){l({type:"error",text:"User and Role are required"});return}const t=N(o);if(!t){l({type:"error",text:"You must be signed in to assign roles."});return}D(!0);try{const a={UserID:r.UserID,RoleID:r.RoleID,EffectiveFrom:r.EffectiveFrom||null,EffectiveTo:r.EffectiveTo||null,IsActive:r.IsActive?1:0,CreatedBy:t};await x({url:"/user-roles",method:"post",data:a}),l({type:"success",text:"Role assigned to user"}),U(),await j(1)}catch(a){console.error("createUserRole error",a),l({type:"error",text:a?.response?.data?.message||a.message||"Failed to assign role"})}finally{D(!1)}},$=s=>i({open:!0,id:s.UserRoleID||s.Id||null,form:{EffectiveFrom:s.EffectiveFrom||"",EffectiveTo:s.EffectiveTo||"",IsActive:!!s.IsActive},saving:!1}),L=async()=>{const{id:s,form:t}=c;if(!s)return;const a=N(o);i(d=>({...d,saving:!0}));try{await x({url:`/user-roles/${s}`,method:"put",data:{EffectiveFrom:t.EffectiveFrom||null,EffectiveTo:t.EffectiveTo||null,IsActive:t.IsActive?1:0,UpdatedBy:a}}),l({type:"success",text:"Updated"}),i({open:!1,id:null,form:null,saving:!1}),await j(v.currentPage)}catch(d){console.error("updateUserRole error",d),l({type:"error",text:d?.response?.data?.message||d.message||"Failed to update"}),i(W=>({...W,saving:!1}))}},z=s=>b({open:!0,id:s.UserRoleID||s.Id||null,title:"Delete role assignment",message:"Remove this role from the user?",processing:!1}),Y=async()=>{if(p.open){b(s=>({...s,processing:!0}));try{if(!N(o))throw new Error("You must be signed in to remove roles.");await x({url:`/user-roles/${p.id}`,method:"delete"}),l({type:"success",text:"Removed"}),await j(v.currentPage)}catch(s){console.error("deleteUserRole error",s),l({type:"error",text:s?.response?.data?.message||s.message||"Failed to remove role"})}finally{b({open:!1,id:null,title:"",message:"",processing:!1})}}},q=async()=>{const s=h;if(!s.UserID||!Array.isArray(s.RoleAssignments)||s.RoleAssignments.length===0){l({type:"error",text:"Select a user and at least one role"});return}m(t=>({...t,processing:!0}));try{const t=N(o);await x({url:"/user-roles/bulk-assign",method:"post",data:{UserID:s.UserID,RoleAssignments:s.RoleAssignments,CreatedBy:t}}),l({type:"success",text:"Roles assigned"}),m({open:!1,UserID:"",RoleAssignments:[],processing:!1}),await j(v.currentPage)}catch(t){console.error("bulkAssign error",t),l({type:"error",text:t?.response?.data?.message||t.message||"Failed to assign roles"}),m(a=>({...a,processing:!1}))}};return e.jsxs("div",{className:"space-y-6 h-full",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-slate-900",children:"User Roles"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Assign roles to users and manage user-role assignments."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>m(s=>({...s,open:!0})),className:"px-3 py-2 border rounded",children:"Bulk Assign"}),e.jsxs("button",{onClick:()=>i({open:!0,id:null,form:{...r},saving:!1}),className:"inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded-md text-sm",children:[" ",e.jsx(A,{className:"h-4 w-4"})," New"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white p-6 rounded-lg shadow-sm text-left",children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"Assign Role"}),e.jsxs("form",{onSubmit:M,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"User"}),e.jsxs("select",{value:r.UserID||"",onChange:s=>u(t=>({...t,UserID:s.target.value})),className:"w-full px-3 py-2 border rounded",children:[e.jsx("option",{value:"",children:"-- Select user --"}),I.map(s=>e.jsx("option",{value:s.UserID,children:s.Username||s.Email||s.username},s.UserID))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Role"}),e.jsxs("select",{value:r.RoleID||"",onChange:s=>u(t=>({...t,RoleID:s.target.value})),className:"w-full px-3 py-2 border rounded",children:[e.jsx("option",{value:"",children:"-- Select role --"}),R.map(s=>e.jsx("option",{value:s.RoleID,children:s.RoleName},s.RoleID))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Effective From"}),e.jsx("input",{type:"date",value:r.EffectiveFrom||"",onChange:s=>u(t=>({...t,EffectiveFrom:s.target.value})),className:"w-full px-3 py-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Effective To"}),e.jsx("input",{type:"date",value:r.EffectiveTo||"",onChange:s=>u(t=>({...t,EffectiveTo:s.target.value})),className:"w-full px-3 py-2 border rounded"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:r.IsActive,onChange:s=>u(t=>({...t,IsActive:s.target.checked})),className:"form-checkbox h-4 w-4"}),e.jsx("span",{children:"Active"})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"submit",disabled:T,className:"inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md",children:[" ",e.jsx(A,{className:"h-4 w-4"})," Create"]}),e.jsx("button",{type:"button",onClick:U,className:"px-3 py-2 border rounded-md",children:"Reset"})]}),f&&e.jsx("div",{className:`text-sm ${f.type==="error"?"text-red-600":"text-green-600"}`,children:f.text})]})]}),e.jsxs("div",{className:"lg:col-span-2 bg-white p-6 rounded-lg shadow-sm overflow-auto text-left",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"All User Roles"}),e.jsx("div",{className:"text-sm text-slate-500",children:C?"Loading...":`${v.totalCount||g.length||0} assignments`})]}),e.jsx("div",{className:"w-full overflow-auto",children:e.jsxs("table",{className:"w-full text-sm table-auto text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-slate-600",children:[e.jsx("th",{className:"p-3",children:"User"}),e.jsx("th",{className:"p-3",children:"Role"}),e.jsx("th",{className:"p-3",children:"Effective From"}),e.jsx("th",{className:"p-3",children:"Effective To"}),e.jsx("th",{className:"p-3",children:"Active"}),e.jsx("th",{className:"p-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[g&&g.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"p-3 text-slate-500",children:"No assignments found."})}),g&&g.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3 align-top font-medium text-slate-800",children:s.Username||s.Email||s.User}),e.jsx("td",{className:"p-3 align-top text-slate-600",children:s.RoleName||s.Role}),e.jsx("td",{className:"p-3 align-top",children:s.EffectiveFrom||"-"}),e.jsx("td",{className:"p-3 align-top",children:s.EffectiveTo||"-"}),e.jsx("td",{className:"p-3 align-top",children:s.IsActive?e.jsx("span",{className:"text-green-600",children:"Yes"}):e.jsx("span",{className:"text-red-600",children:"No"})}),e.jsx("td",{className:"p-3 align-top",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>$(s),className:"p-2 rounded-md hover:bg-gray-100",title:"Edit",children:e.jsx(H,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>z(s),className:"p-2 rounded-md hover:bg-red-50 text-red-600",title:"Delete",children:e.jsx(J,{className:"h-4 w-4"})})]})})]},s.UserRoleID||s.Id||`${s.UserID}-${s.RoleID}`))]})]})})]})]}),e.jsx(E,{open:c.open,onClose:()=>i({open:!1,id:null,form:null}),title:c.form?"Edit":"Edit User Role",children:c.form&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Effective From"}),e.jsx("input",{type:"date",value:c.form.EffectiveFrom||"",onChange:s=>i(t=>({...t,form:{...t.form,EffectiveFrom:s.target.value}})),className:"w-full px-3 py-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Effective To"}),e.jsx("input",{type:"date",value:c.form.EffectiveTo||"",onChange:s=>i(t=>({...t,form:{...t.form,EffectiveTo:s.target.value}})),className:"w-full px-3 py-2 border rounded"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!c.form.IsActive,onChange:s=>i(t=>({...t,form:{...t.form,IsActive:s.target.checked}})),className:"form-checkbox h-4 w-4"}),e.jsx("span",{children:"Active"})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>i({open:!1,id:null,form:null}),className:"px-4 py-2 rounded border",children:"Cancel"}),e.jsx("button",{onClick:L,disabled:c.saving,className:"px-4 py-2 bg-indigo-600 text-white rounded",children:c.saving?"Saving...":"Update"})]}),f&&e.jsx("div",{className:`text-sm ${f.type==="error"?"text-red-600":"text-green-600"}`,children:f.text})]})}),e.jsx(E,{open:h.open,onClose:()=>m({open:!1,UserID:"",RoleAssignments:[],processing:!1}),title:"Bulk Assign Roles",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"User"}),e.jsxs("select",{value:h.UserID||"",onChange:s=>m(t=>({...t,UserID:s.target.value})),className:"w-full px-3 py-2 border rounded",children:[e.jsx("option",{value:"",children:"-- Select user --"}),I.map(s=>e.jsx("option",{value:s.UserID,children:s.Username||s.Email},s.UserID))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Roles"}),e.jsx("div",{className:"grid grid-cols-2 gap-2 max-h-48 overflow-auto border p-2 rounded",children:R.map(s=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:h.RoleAssignments.some(t=>t.RoleID===s.RoleID),onChange:t=>m(a=>({...a,RoleAssignments:t.target.checked?[...a.RoleAssignments,{RoleID:s.RoleID}]:a.RoleAssignments.filter(d=>d.RoleID!==s.RoleID)}))}),s.RoleName]},s.RoleID))})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>m({open:!1,UserID:"",RoleAssignments:[],processing:!1}),className:"px-3 py-2 border rounded",children:"Cancel"}),e.jsx("button",{onClick:q,disabled:h.processing,className:"px-3 py-2 bg-indigo-600 text-white rounded",children:h.processing?"Processing...":"Assign"})]})]})}),e.jsx(K,{open:p.open,title:p.title,message:p.message,onCancel:()=>b({open:!1,id:null,title:"",message:"",processing:!1}),onConfirm:Y,confirmLabel:"Yes",cancelLabel:"No",loading:p.processing})]})}export{Q as default};
